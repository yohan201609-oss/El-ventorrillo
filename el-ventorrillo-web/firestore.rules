rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Reglas para usuarios
    match /users/{userId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.auth.uid == userId;
      allow update: if request.auth != null && request.auth.uid == userId;
      allow delete: if request.auth != null && request.auth.uid == userId;
    }
    
    // Reglas para productos
    match /products/{productId} {
      allow read: if true;
      allow create: if request.auth != null 
                    && request.resource.data.sellerId == request.auth.uid;
      allow update: if request.auth != null 
                    && resource.data.sellerId == request.auth.uid;
      allow delete: if request.auth != null 
                    && resource.data.sellerId == request.auth.uid;
    }
    
    // Reglas para conversaciones
    match /conversations/{conversationId} {
      // Permitir lectura si el usuario está autenticado
      // Si el documento existe, verificar que sea participante
      // Si no existe, permitir la lectura para verificar existencia
      allow read: if request.auth != null;
      
      // Permitir crear conversación si el usuario está autenticado y es participante
      allow create: if request.auth != null 
                    && request.resource.data.participants is list
                    && request.auth.uid in request.resource.data.participants;
      
      // Los participantes pueden actualizar su conversación
      allow update: if request.auth != null 
                    && (resource == null || request.auth.uid in resource.data.participants);
      
      // Los participantes pueden eliminar su conversación
      allow delete: if request.auth != null 
                    && (resource == null || request.auth.uid in resource.data.participants);
      
      // Reglas para mensajes dentro de conversaciones
      match /messages/{messageId} {
        // Permitir lectura si el usuario está autenticado
        // Simplificado para desarrollo
        allow read: if request.auth != null;
        
        // Solo el remitente puede crear mensajes
        allow create: if request.auth != null 
                      && request.resource.data.senderId == request.auth.uid;
        
        // Solo el remitente puede actualizar sus mensajes
        allow update: if request.auth != null 
                      && (resource == null || resource.data.senderId == request.auth.uid);
        
        // Solo el remitente puede eliminar sus mensajes
        allow delete: if request.auth != null 
                      && (resource == null || resource.data.senderId == request.auth.uid);
      }
    }
    
    // Reglas para favoritos
    match /favorites/{favoriteId} {
      // Los usuarios solo pueden leer sus propios favoritos
      allow read: if request.auth != null 
                  && resource.data.userId == request.auth.uid;
      
      // Los usuarios solo pueden crear sus propios favoritos
      allow create: if request.auth != null 
                    && request.resource.data.userId == request.auth.uid;
      
      // Los usuarios solo pueden eliminar sus propios favoritos
      allow delete: if request.auth != null 
                    && resource.data.userId == request.auth.uid;
    }
  }
}

